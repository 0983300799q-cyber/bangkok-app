<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ›¼è°·æ—…éŠè¦åŠƒ App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #E2E2D5; color: #333; }
        .hard-shadow { border: 3px solid #333; box-shadow: 6px 6px 0px #333; }
        .active-press:active { transform: translate(3px, 3px); box-shadow: 2px 2px 0px #333; }
        * { -webkit-touch-callout: none; -webkit-user-select: none; }
        .category-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; border: 1px solid #333; margin-right: 6px; }
        .checked-item { text-decoration: line-through; opacity: 0.5; }
    </style>
</head>
<body class="p-4 pb-32">

    <div class="grid grid-cols-2 gap-4">
        <div class="col-span-2 bg-[#98A393] p-6 rounded-2xl hard-shadow text-white relative active-press">
            <div class="text-xs font-bold opacity-90 mb-1 tracking-widest">UPCOMING TRIP</div>
            <div class="text-3xl font-black mb-1">æ›¼è°· BANGKOK</div>
            <div class="text-sm font-bold opacity-90 text-yellow-200">2026.01.20 - 01.26</div>
            <div class="absolute -right-2 -bottom-2 text-7xl opacity-30">âœˆï¸</div>
        </div>

        <div id="btn-expense" class="bg-[#abacad] p-5 rounded-2xl hard-shadow flex flex-col items-center justify-center aspect-square active-press cursor-pointer">
            <span class="text-5xl mb-3">ğŸ’´</span>
            <span class="text-lg font-black tracking-tighter">è¨˜å¸³æœ¬</span>
        </div>
        <div id="btn-gift" class="bg-[#c9c5c2] p-5 rounded-2xl hard-shadow flex flex-col items-center justify-center aspect-square active-press cursor-pointer">
            <span class="text-5xl mb-3">ğŸ</span>
            <span class="text-lg font-black tracking-tighter">ä¼´æ‰‹ç¦®</span>
        </div>
        <div id="btn-pack" class="bg-[#e5e1d8] p-5 rounded-2xl hard-shadow flex flex-col items-center justify-center aspect-square active-press cursor-pointer">
            <span class="text-5xl mb-3">ğŸ’</span>
            <span class="text-lg font-black tracking-tighter">è¡Œææ¸…å–®</span>
        </div>
        <div id="btn-plan" class="bg-[#f1efe9] p-5 rounded-2xl hard-shadow flex flex-col items-center justify-center aspect-square active-press cursor-pointer">
            <span class="text-5xl mb-3">ğŸ—“ï¸</span>
            <span class="text-lg font-black tracking-tighter">æŸ¥çœ‹è¡Œç¨‹</span>
        </div>
    </div>

    <div id="display-section" class="mt-8 space-y-6">
        
        <div class="p-6 bg-white rounded-2xl hard-shadow">
            <div class="flex justify-between items-center mb-4">
                <h3 id="list-title" class="font-black text-xl text-[#333]">ğŸ’° èŠ±è²»çµ±è¨ˆ</h3>
                <button id="main-add-btn" class="bg-black text-white text-xs px-3 py-1 rounded-full font-bold">+ æ–°å¢</button>
            </div>
            
            <div id="total-area" class="mb-4">
                <div id="total-amount" class="text-4xl font-black text-[#A68A7E]">å°å¹£ $0</div>
            </div>

            <div id="main-list" class="space-y-3 font-bold">
                <div class="text-gray-400 italic text-center">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="text-[10px] font-bold text-gray-400 mt-4">ğŸ’¡ æç¤ºï¼šé•·æŒ‰é …ç›®å¯åˆªé™¤ç´€éŒ„</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, deleteDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD4AWcw5vICugtgdqbu1eYGOfPml45ejYo",
            authDomain: "traveling-bk.firebaseapp.com",
            projectId: "traveling-bk",
            storageBucket: "traveling-bk.firebasestorage.app",
            messagingSenderId: "618896170703",
            appId: "1:618896170703:web:3b933f0b6558f30f75a1ba",
            measurementId: "G-29L3T7QLS3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentMode = "expenses"; // é è¨­æ¨¡å¼

        // é€šç”¨é•·æŒ‰åˆªé™¤å‡½æ•¸
        window.bindLongPress = (id, collectionName, displayName) => {
            const el = document.getElementById(`item-${id}`);
            let timer;
            el.ontouchstart = () => {
                timer = setTimeout(async () => {
                    if (confirm(`ç¢ºå®šåˆªé™¤ã€Œ${displayName}ã€å—ï¼Ÿ`)) {
                        await deleteDoc(doc(db, collectionName, id));
                    }
                }, 600);
            };
            el.ontouchend = () => clearTimeout(timer);
        };

        // é‡æ–°è®€å–æ¸…å–®çš„å‡½æ•¸
        const refreshDisplay = () => {
            const listTitle = document.getElementById('list-title');
            const totalArea = document.getElementById('total-area');
            
            // æ ¹æ“šæ¨¡å¼åˆ‡æ› UI
            if (currentMode === "expenses") {
                listTitle.innerText = "ğŸ’° èŠ±è²»çµ±è¨ˆ";
                totalArea.style.display = "block";
            } else if (currentMode === "gifts") {
                listTitle.innerText = "ğŸ ä¼´æ‰‹ç¦®æ¸…å–®";
                totalArea.style.display = "none";
            } else if (currentMode === "packing") {
                listTitle.innerText = "ğŸ’ è¡Œææ¸…å–®";
                totalArea.style.display = "none";
            } else {
                listTitle.innerText = "ğŸ—“ï¸ æ—…éŠè¡Œç¨‹";
                totalArea.style.display = "none";
            }

            // å³æ™‚ç›£è½è³‡æ–™åº«
            const q = query(collection(db, currentMode), orderBy("time", currentMode === "plans" ? "asc" : "desc"));
            onSnapshot(q, (snap) => {
                let html = "";
                let total = 0;
                
                snap.forEach(d => {
                    const data = d.data();
                    if (currentMode === "expenses") {
                        total += data.twd;
                        const catColor = { "é£Ÿ": "#FFD700", "è¡£": "#FFB6C1", "ä½": "#87CEFA", "è¡Œ": "#90EE90", "æ¨‚": "#DDA0DD" }[data.category] || "#EEE";
                        html += `<div class="flex justify-between items-center bg-gray-50 p-2 rounded-lg border-2 border-black" id="item-${d.id}">
                                    <div><span class="category-tag" style="background-color:${catColor}">${data.category}</span>${data.item}</div>
                                    <span>$${data.twd}</span>
                                 </div>`;
                    } else if (currentMode === "plans") {
                        html += `<div class="bg-gray-50 p-3 rounded-lg border-2 border-black" id="item-${d.id}">
                                    <div class="text-xs text-[#98A393] mb-1">Step</div>
                                    <div class="text-sm font-black">${data.title}</div>
                                 </div>`;
                    } else {
                        html += `<div class="flex items-center bg-gray-50 p-3 rounded-lg border-2 border-black" id="item-${d.id}" onclick="window.toggleTask('${d.id}', ${data.done})">
                                    <div class="w-5 h-5 border-2 border-black mr-3 flex items-center justify-center bg-white">${data.done ? "âœ“" : ""}</div>
                                    <span class="${data.done ? 'checked-item' : ''}">${data.name}</span>
                                 </div>`;
                    }
                });

                document.getElementById('main-list').innerHTML = html || `<div class="text-gray-300 italic text-center">ç›®å‰æ²’æœ‰è³‡æ–™</div>`;
                document.getElementById('total-amount').innerText = `å°å¹£ $${total}`;
                
                // ç¶å®šé•·æŒ‰åˆªé™¤
                snap.forEach(d => window.bindLongPress(d.id, currentMode, d.data().item || d.data().name || d.data().title));
            });
        };

        // åˆ‡æ›æŒ‰éˆ•äº‹ä»¶
        document.getElementById('btn-expense').onclick = () => { currentMode = "expenses"; refreshDisplay(); };
        document.getElementById('btn-gift').onclick = () => { currentMode = "gifts"; refreshDisplay(); };
        document.getElementById('btn-pack').onclick = () => { currentMode = "packing"; refreshDisplay(); };
        document.getElementById('btn-plan').onclick = () => { currentMode = "plans"; refreshDisplay(); };

        // å‹¾é¸åŠŸèƒ½
        window.toggleTask = async (id, status) => { await updateDoc(doc(db, currentMode, id), { done: !status }); };

        // é€šç”¨æ–°å¢æŒ‰éˆ• (æ ¹æ“šç•¶å‰æ¨¡å¼å½ˆå‡ºä¸åŒè¦–çª—)
        document.getElementById('main-add-btn').onclick = async () => {
            if (currentMode === "expenses") {
                const cat = prompt("åˆ†é¡ (é£Ÿ/è¡£/ä½/è¡Œ/æ¨‚):", "é£Ÿ");
                const thb = prompt("æ³°éŠ–é‡‘é¡:");
                const item = prompt("å‚™è¨»:");
                if (cat && thb) await addDoc(collection(db, "expenses"), { category: cat, item: item || "æ¶ˆè²»", thb: Number(thb), twd: Math.round(thb * 0.92), time: serverTimestamp() });
            } else if (currentMode === "plans") {
                const title = prompt("æ–°å¢è¡Œç¨‹å…§å®¹ (ä¾‹å¦‚ï¼š10:00 æ°åœ–æ°å¸‚é›†):");
                if (title) await addDoc(collection(db, "plans"), { title, time: serverTimestamp() });
            } else {
                const name = prompt("æ–°å¢é …ç›®åç¨±:");
                if (name) await addDoc(collection(db, currentMode), { name, done: false, time: serverTimestamp() });
            }
        };

        // åˆå§‹åŒ–
        refreshDisplay();
    </script>
</body>
</html>
